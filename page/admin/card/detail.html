<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8" />
        <title>账户详情</title>
        <meta name="renderer" content="webkit" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <link rel="stylesheet" href="/lib/layui/css/layui.css" media="all" />
        <link rel="stylesheet" href="/css/public.css" media="all" />
        <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all" />
        <style>
            #searchBtn {
                position: absolute;
                right: 18px;
            }
        </style>
    </head>

    <body>
        <div class="layuimini-container">
            <div class="layuimini-main">
                <form class="layui-form layui-form-pane" action="" lay-filter="detail">
                    <div class="layui-form-item">
                        <label class="layui-form-label">账号</label>
                        <div class="layui-input-block">
                            <input
                                type="text"
                                name="account"
                                lay-verify="required"
                                class="layui-input"
                                oninput="accountOnEdit(event)"
                            />
                        </div>
                    </div>

                    <div class="layui-bg-gray" style="margin-bottom: 15px">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md6">
                                <div class="layui-card">
                                    <div class="layui-card-header">账户信息</div>
                                    <div class="layui-card-body">
                                        <table class="layui-table" lay-skin="nob">
                                            <tbody id="account_tbody">
                                                <tr>
                                                    <td>账户ID</td>
                                                    <td>2</td>
                                                </tr>
                                                <tr>
                                                    <td>账户角色</td>
                                                    <td>user</td>
                                                </tr>
                                                <tr>
                                                    <td>账户状态</td>
                                                    <td>user</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="layui-col-md6">
                                <div class="layui-card">
                                    <div class="layui-card-header">卡信息</div>
                                    <div class="layui-card-body">
                                        <table class="layui-table" lay-skin="nob">
                                            <tbody id="card_tbody">
                                                <tr>
                                                    <td>卡ID</td>
                                                    <td>2</td>
                                                </tr>
                                                <tr>
                                                    <td>所属账户</td>
                                                    <td>2</td>
                                                </tr>
                                                <tr>
                                                    <td>卡余额</td>
                                                    <td>user</td>
                                                </tr>
                                                <tr>
                                                    <td>卡状态</td>
                                                    <td>user</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="layui-col-md6">
                                <div class="layui-card">
                                    <div class="layui-card-header">用户信息</div>
                                    <div class="layui-card-body">
                                        <table class="layui-table" lay-skin="nob">
                                            <tbody id="user_tbody">
                                                <tr>
                                                    <td>ID</td>
                                                    <td>2</td>
                                                </tr>
                                                <tr>
                                                    <td>姓名</td>
                                                    <td>user2</td>
                                                </tr>
                                                <tr>
                                                    <td>拥有卡ID</td>
                                                    <td>user</td>
                                                </tr>
                                                <tr>
                                                    <td>邮件</td>
                                                    <td>2@qq.com</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="layui-col-md6">
                                <div class="layui-card">
                                    <div class="layui-card-header">部门信息</div>
                                    <div class="layui-card-body">
                                        <table class="layui-table" lay-skin="nob">
                                            <tbody id="department_tbody">
                                                <tr>
                                                    <td>ID</td>
                                                    <td>2</td>
                                                </tr>
                                                <tr>
                                                    <td>姓名</td>
                                                    <td>user2</td>
                                                </tr>
                                                <tr>
                                                    <td>拥有卡ID</td>
                                                    <td>user</td>
                                                </tr>
                                                <tr>
                                                    <td>邮件</td>
                                                    <td>2@qq.com</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-btn-container">
                            <button type="button" lay-submit lay-filter="cabceled" class="layui-btn layui-btn-danger">
                                <i class="fa fa-close"></i> 注销
                            </button>
                            <button type="button" lay-submit lay-filter="state" class="layui-btn layui-btn-danger">
                                <i class="fa fa-lock"></i> 挂失 / 解挂
                            </button>
                            <button
                                type="button"
                                lay-submit
                                lay-filter="resetPassword"
                                class="layui-btn layui-btn-warm"
                            >
                                <i class="fa fa-key"></i> 重置密码
                            </button>
                            <button type="button" lay-submit lay-filter="consume" class="layui-btn layui-bg-green">
                                <i class="fa fa-bar-chart"></i> 消费查询
                            </button>
                            <button type="button" lay-submit lay-filter="recharge" class="layui-btn layui-bg-green">
                                <i class="fa fa-jpy"></i> 充值
                            </button>
                            <button class="layui-btn layui-bg-green" lay-submit lay-filter="searchBtn" id="searchBtn">
                                <i class="fa fa-search"></i> 查询
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <script src="/lib/layui/layui.js"></script>
        <script src="/js/lay-module/layuimini/miniTab.js"></script>
        <script src="/lib/util/layui_verify_config.js"></script>
        <script src="/lib/util/amount.js"></script>
        <script src="/lib/util/common.js"></script>
        <script>
            let form,
                $,
                layer,
                loaded = false,
                miniTab;

            layui.use(['form'], function () {
                layer = layui.layer;
                $ = layui.$;
                form = layui.form;
                miniTab = layui.miniTab;

                //配置layui表单验证配置
                form.verify(layui_verify_config);

                const accountId = sessionStorage.getItem(window.top.location.hash);
                sessionStorage.removeItem(window.top.location.hash);

                //给表单赋值
                form.val('detail', {
                    account: accountId,
                });

                // 搜索
                form.on('submit(searchBtn)', function (data) {
                    $.ajax({
                        // url: common.url('/account/one/account-info.do'),
                        url: './index.test.json',
                        data: { account: data.field.account },
                        type: 'get',
                        dataType: 'json',
                        xhrFields: {
                            withCredentials: true,
                        },
                        success: function (res) {
                            if (!res.success) {
                                layer.msg('未查询到', { icon: 2 });
                                return;
                            }
                            loaded = true;
                            //赋值
                            setData(res.data);

                            //判断如果已经注销，禁用 注销、解挂、挂失 按钮
                            const { account, card, user, departmentChain } = res.data;
                            if (account.state === 'canceled') {
                                const cabceledBtn = document.querySelector('button[lay-filter="cabceled"]');
                                const stateBtn = document.querySelector('button[lay-filter="state"]');
                                const resetPasswordBtn = document.querySelector('button[lay-filter="resetPassword"]');
                                const rechargeBtn = document.querySelector('button[lay-filter="recharge"]');

                                cabceledBtn.disabled = true;
                                cabceledBtn.className += ' layui-btn-disabled';
                                stateBtn.disabled = true;
                                stateBtn.className += ' layui-btn-disabled';
                                resetPasswordBtn.disabled = true;
                                resetPasswordBtn.className += ' layui-btn-disabled';
                                rechargeBtn.disabled = true;
                                rechargeBtn.className += ' layui-btn-disabled';
                            }
                            //如果挂失，显示解挂，如果未挂失，显示挂失
                            const stateBtn = document.querySelector('button[lay-filter="state"]');
                            if (card.state === 'loss') {
                                stateBtn.innerHTML = '<i class="fa fa-unlock-alt"></i> 解挂';
                            } else {
                                stateBtn.innerHTML = '<i class="fa fa-lock"></i> 挂失';
                            }
                            loaded = true;
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            layer.msg(jqXHR.status + '', { icon: 2 });
                        },
                    });
                    return false;
                });

                // 重置密码
                form.on('submit(resetPassword)', function (data) {
                    if (!loaded) {
                        layer.msg('请先查询', { icon: 2 });
                        return false;
                    }

                    layer.open({
                        title: '重置密码',
                        content: '确认重置密码吗?',
                        btn: ['重置', '取消'],
                        icon: 3,
                        shadeClose: true,
                        btn1: function (index) {
                            $.ajax({
                                url: '/account/update/resetPassword.do',
                                data: { user: data.field.id },
                                type: 'post',
                                dataType: 'json',
                                success: function (res) {
                                    if (res.success) {
                                        layer.msg(res.message, { icon: 1 });
                                        return;
                                    }
                                    layer.msg(res.message, { icon: 2 });
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    layer.msg(jqXHR.status + '', { icon: 2 });
                                },
                            });
                        },
                    });
                    return false;
                });

                //挂失/解挂
                form.on('submit(state)', function (data) {
                    if (!loaded) {
                        layer.msg('请先查询', { icon: 2 });
                        return false;
                    }

                    const user = data.field.id;
                    const status = data.field.lock === 'true';

                    layer.open({
                        title: '挂失',
                        content: !status ? '确认挂失吗' : '确认解挂吗',
                        btn: ['确定', '取消'],
                        icon: 3,
                        shadeClose: true,
                        btn1: function (index) {
                            lockOrUnlock(user, !status);
                        },
                    });
                });

                //注销
                form.on('submit(cabceled)', function (data) {
                    console.log(data);
                    if (!loaded) {
                        layer.msg('请先查询', { icon: 2 });
                        return false;
                    }

                    const user = data.field.id;

                    layer.open({
                        title: '注销',
                        content: '确认注销吗?',
                        btn: ['注销', '取消'],
                        icon: 3,
                        shadeClose: true,
                        btn1: function (index) {
                            cabceled(user);
                        },
                    });
                });

                //充值
                form.on('submit(recharge)', function (data) {
                    console.log(data);
                    if (!loaded) {
                        layer.msg('请先查询', { icon: 2 });
                        return false;
                    }

                    const user = data.field.id;

                    layer.prompt({ title: '充值', formType: 0 }, function (amount, index) {
                        //判断是否为金额
                        if (!isAmount(amount)) {
                            layer.msg('不是金额', { icon: 2 });
                            return false;
                        }

                        //判断小数位数是否为1或2位
                        const dl = decimalLength(amount);
                        if (!(dl <= 2 && dl >= 0)) {
                            layer.msg(`小数点后最多两位(${dl})`, { icon: 2 });
                            return false;
                        }

                        if (!amountInRange(amount, 1, 1000)) {
                            layer.msg(`充值金额在 1~1000 元(${amount})`, { icon: 2 });
                            return false;
                        }
                        recharge(user, amountMulti(amount, 2));
                        layer.close(index);
                    });
                });

                form.on('submit(consume)', function (data) {
                    console.log(data);
                    //关闭之前打开的详情页
                    const tabCloseBtn = window.top.document.querySelector(
                        'li[lay-id="page/admin/consume/index.html"]>i'
                    );
                    if (tabCloseBtn != null) {
                        tabCloseBtn.click();
                    }
                    //消费记录页面
                    sessionStorage.setItem('page/admin/consume/index.html', data.field.id.toString());
                    miniTab.openNewTabByIframe({
                        href: 'page/admin/consume/index.html',
                        title: '消费列表',
                    });
                });

                //如果获取到账号，则自动查询
                if (accountId != null) {
                    document.querySelector('#searchBtn').click();
                }
                return false;
            });

            /**
             * 账号输入框编辑监听
             * 修改账号输入框时将其他输入框重置
             * @param e
             */
            function accountOnEdit(e) {
                loaded = false;
                setData();
            }

            /**
             * 挂失/解挂
             * @param user 学生ID
             * @param toLockStatus 将要设置卡的状态 true去挂失，false解挂
             */
            function lockOrUnlock(user, toLockStatus) {
                $.ajax({
                    url: '/card/update/state.do',
                    data: { user: user, lock: toLockStatus },
                    type: 'post',
                    dataType: 'json',
                    success: function (res) {
                        if (res.success) {
                            layer.msg(res.message, { icon: 1 });
                            //重新查询
                            document.querySelector('#searchBtn').click();
                            return;
                        }
                        layer.msg(res.message, { icon: 2 });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        layer.msg(jqXHR.status + '', { icon: 2 });
                    },
                });
            }

            /**
             * 注销
             * @param user 账号
             */
            function cabceled(user) {
                $.ajax({
                    url: '/account/update/cabceled.do',
                    data: { user: user },
                    type: 'post',
                    dataType: 'json',
                    success: function (res) {
                        if (res.success) {
                            layer.msg(res.message, { icon: 1 });
                            //重新查询
                            document.querySelector('#searchBtn').click();
                            return;
                        }
                        layer.msg(res.message, { icon: 2 });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        layer.msg(jqXHR.status + '', { icon: 2 });
                    },
                });
            }

            /**
             * 充值
             * @param user 账号
             */
            function recharge(user, balance) {
                $.ajax({
                    url: '/card/update/recharge.do',
                    data: { user, balance },
                    type: 'post',
                    dataType: 'json',
                    success: function (res) {
                        if (res.success) {
                            layer.msg(res.message, { icon: 1 });
                            //重新查询
                            document.querySelector('#searchBtn').click();
                            return;
                        }
                        layer.msg(res.message, { icon: 2 });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        layer.msg(jqXHR.status + '', { icon: 2 });
                    },
                });
            }

            /**
             * 设置值
             * @param data 数据, 为null或不传时时清空
             */
            function setData(data) {
                if (data == null || data == undefined) {
                    data = {
                        account: {
                            id: '',
                            role: '',
                            state: '',
                        },
                        card: {
                            id: '',
                            account: '',
                            balance: '',
                            state: '',
                        },
                        user: {
                            id: '',
                            name: '',
                            card: '',
                            email: '',
                        },
                        departmentChain: [
                            {
                                id: '',
                                name: '',
                            },
                        ],
                    };
                }

                // 几个内容块的id
                const account_tbody = document.querySelector('#account_tbody');
                const card_tbody = document.querySelector('#card_tbody');
                const user_tbody = document.querySelector('#user_tbody');
                const department_tbody = document.querySelector('#department_tbody');

                const { account, card, user, departmentChain } = data;
                account_tbody.innerHTML = `<tr>
                        <td>账户ID</td>
                        <td>${account.id}</td>
                    </tr>
                    <tr>
                        <td>账户角色</td>
                        <td>${
                            account.role === 'user'
                                ? '用户'
                                : account.role === 'admin'
                                ? '管理员'
                                : account.role === 'pos'
                                ? '刷卡机'
                                : ''
                        }</td>
                    </tr>
                    <tr>
                        <td>账户状态</td>
                        <td>${
                            account.state === 'normal'
                                ? '正常'
                                : account.state === 'canceled'
                                ? '注销'
                                : account.state === 'frozen'
                                ? '冻结'
                                : ''
                        }</td>
                    </tr>`;

                card_tbody.innerHTML = `<tr>
                        <td>卡ID</td>
                        <td>${card.id}</td>
                    </tr>
                    <tr>
                        <td>所属账户</td>
                        <td>${card.account}</td>
                    </tr>
                    <tr>
                        <td>卡余额</td>
                        <td>${card.balance === '' ? '' : card.balance / 100}</td>
                    </tr>
                    <tr>
                        <td>卡状态</td>
                        <td>${
                            card.state === 'normal'
                                ? '正常'
                                : card.state === 'canceled'
                                ? '注销'
                                : card.state === 'loss'
                                ? '丢失'
                                : ''
                        }</td>
                    </tr>`;

                user_tbody.innerHTML = `<tr>
                        <td>ID</td>
                        <td>${user.id}</td>
                    </tr>
                    <tr>
                        <td>姓名</td>
                        <td>${user.name}</td>
                    </tr>
                    <tr>
                        <td>拥有卡ID</td>
                        <td>${user.card}</td>
                    </tr>
                    <tr>
                        <td>邮件</td>
                        <td>${user.email}</td>
                    </tr>`;

                let department_str = '';
                departmentChain.forEach((department) => {
                    department_str += department.name + ' > ';
                });

                department_tbody.innerHTML = `<tr>
                        <td>ID</td>
                        <td>${departmentChain[departmentChain.length - 1].id}</td>
                    </tr>
                    <tr>
                        <td>部门</td>
                        <td>${department_str.substring(0, department_str.length - 3)}</td>
                    </tr>`;
            }
        </script>
    </body>
</html>
