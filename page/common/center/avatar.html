<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <title>头像</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="/lib/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all" />
    <link rel="stylesheet" href="/lib/cropper/cropper.min.css">
    <style>
        .image {
            object-fit: contain;
            width: 100%;
            height: 100%;
        }

        .image-box {
            width: 200px;
            height: 200px;
        }

        .preview {
            border-radius: 50%;
        }

        #preview {
            overflow: hidden;
        }

        .file {
            margin-bottom: 16px;
            line-height: 38px;
        }

        .file::before {
            margin-right: 12px;
        }

        .btn-group {
            margin-top: 16px;
        }
    </style>
</head>

<body>
    <div class="layuimini-container">
        <div id="app" class="layuimini-main">
            <div class="layui-bg-gray" style="padding: 16px;">
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-xs12 layui-col-sm12 layui-col-md4 layui-col-lg4 layui-col-xl4">
                        <div class="layui-card">
                            <div class="layui-card-header">当前头像</div>
                            <div class="layui-card-body">
                                <div class="layui-row image-box">
                                    <img :src="originalImage" class="image" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-sm12 layui-col-md8 layui-col-lg8 layui-col-xl8">
                        <div class="layui-card">
                            <div class="layui-card-header">修改头像</div>
                            <div class="layui-card-body">
                                <div class="layui-row">
                                    <input type="file" ref="fileRef"
                                        class="layui-btn layui-btn-primary file fa fa-upload" accept=".jpg,.jpeg"
                                        @change="onimagechange" />
                                </div>
                                <div
                                    class="image-box layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12 layui-col-xl12">
                                    <img :src="sourcesImage" class="image" ref="imgRef" crossorigin="anonymous">
                                </div>
                                <div id="preview" class="image-box">
                                    <img class="image preview" />
                                </div>
                                <div class="layui-row btn-group">
                                    <button type="primary" size="mini" @click="EditSeal('tailor')"
                                        class="layui-btn fa fa-check"> 确定</button>
                                    <button type="primary" size="mini" @click="EditSeal('restore')"
                                        class="layui-btn layui-btn-primary fa fa-repeat"> 还原</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script src="/lib/layui/layui.js"></script>
    <script src="/lib/util/config.js"></script>
    <script src="/lib/vue2/vue.js"></script>
    <script src="/lib/cropper/cropper.min.js"></script>
    <script>
        let $, layer, upload;

        let app = new Vue({
            el: "#app",
            data: {
                originalImage: "/test/avatar.jpg",
                cropper: null,
                sourcesImage: null,
                cropImageBase64: ''

            },
            mounted() {
                this.cropImage();
            },
            methods: {
                cropImage() {
                    this.cropper = new Cropper(this.$refs.imgRef, {
                        aspectRatio: 1, // 裁剪框的默认比例
                        preview: "#preview", // 预览视图
                        viewMode: 1, //0 无限制 1 限制裁剪框不能超出图片的范围 2 限制裁剪框不能超出图片的范围 且图片填充模式为 cover 最长边填充3 限制裁剪框不能超出图片的范围 且图片填充模式为 contain 最短边填充
                        autoCropArea: 1, // 0-1之间的数值，定义自动剪裁区域的大小，默认0.8
                        resizable: true, // 是否允许改变裁剪框的大小
                        scalable: true, //是否可以缩放图片，默认true
                        restore: false, //窗口改变后 恢复被裁剪的区域 默认true
                        dragMode: "none", // none禁止重新框选选取
                    });
                    // console.log(this.cropper);
                },

                EditSeal(method) {
                    if (method) {
                        switch (method) {
                            case "tailor":
                                this.tailor();
                                break;
                            case "restore":
                                this.cropper.reset();
                                break;
                        }
                    }
                },
                tailor() {
                    let result = this.cropper.getCroppedCanvas(); //获取裁剪后数据\
                    if (!result) {
                        layer.msg('请先选择图片');
                        return false;
                    }
                    let base64url = result.toDataURL("image/jpeg");
                    this.cropImageBase64 = base64url;
                    console.log(base64url);
                    // TODO: 上传图片
                },

                onimagechange() {
                    const _this = this;
                    let reader = new FileReader();
                    reader.readAsDataURL(this.$refs.fileRef.files[0]); // 读出 base64
                    reader.onloadend = async function () {
                        const dataURL = reader.result;//base64
                        _this.sourcesImage = dataURL;
                        if (_this.cropper) {
                            await _this.cropper.destroy();
                        }
                        _this.cropImage();
                    };
                },

            },
        })



        layui.use(function () {
            layer = layui.layer;
            $ = layui.$;
            upload = layui.upload;
            return false;
        });
    </script>
</body>

</html>