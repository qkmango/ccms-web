<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <title>账户详情</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="/lib/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all" />
    <style>
        span:last-child .no {
            display: none;
        }
    </style>
</head>

<body>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <form class="layui-form layui-form-pane" lay-filter="detail" id="app">
                <div class="layui-bg-gray" style="margin-bottom: 15px">
                    <div class="layui-row layui-col-space15">
                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">账户信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="account_tbody">
                                            <tr>
                                                <td>账户ID</td>
                                                <td>{{detail?detail.account.id:''}}</td>
                                            </tr>
                                            <tr>
                                                <td>账户角色</td>
                                                <td>{{detail?
                                                    (detail.account.role==='user'?'用户':
                                                    detail.account.role==='admin'?'管理员':
                                                    detail.account.role==='pos'?'刷卡机':'未知')
                                                    :''}}</td>
                                            </tr>
                                            <tr>
                                                <td>账户状态</td>
                                                <td>{{detail?
                                                    (detail.account.state==='normal'? '正常':
                                                    detail.account.state==='canceled'? '注销':
                                                    detail.account.state==='frozen'? '冻结':'未知')
                                                    :''}}</td>
                                            </tr>
                                            <tr>
                                                <td>邮箱</td>
                                                <td>{{detail?detail.account.email:''}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md6" v-show="showCardinfo">
                            <div class="layui-card">
                                <div class="layui-card-header">卡信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="card_tbody">
                                            <tr>
                                                <td>卡ID</td>
                                                <td>{{detail&&detail.card?detail.card.id:''}}</td>
                                            </tr>
                                            <tr>
                                                <td>所属账户</td>
                                                <td>{{detail&&detail.card?detail.card.account:''}}</td>
                                            </tr>
                                            <tr>
                                                <td>卡余额</td>
                                                <td>{{detail&&detail.card?detail.card.balance/100:''}}</td>
                                            </tr>
                                            <tr>
                                                <td>卡状态</td>
                                                <td>{{detail&&detail.card?
                                                    (detail.card.state==='normal'? '正常':
                                                    detail.card.state==='loss'? '挂失':
                                                    detail.card.state==='canceled'? '注销':'未知')
                                                    :''}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md6" v-show="showUserinfo">
                            <div class="layui-card">
                                <div class="layui-card-header">用户信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="user_tbody">
                                            <tr>
                                                <td>ID</td>
                                                <td>{{detail&&detail.user?detail.user.id:''}}</td>
                                            </tr>
                                            <tr>
                                                <td>姓名</td>
                                                <td>{{detail&&detail.user?detail.user.name:''}}</td>
                                            </tr>
                                            <tr>
                                                <td>拥有卡ID</td>
                                                <td>{{detail&&detail.user?detail.user.card:''}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">部门信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="department_tbody">
                                            <tr>
                                                <td>ID</td>
                                                <td>{{detail?
                                                    detail.departmentChain[detail.departmentChain.length-1].id:''}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>部门</td>
                                                <td>
                                                    <span v-show="detail"
                                                        v-for="(value, key, index) in (detail?detail.departmentChain:[])">
                                                        {{ value.name }}
                                                        <span v-if="index !== detail.departmentChain.length - 1"
                                                            class="no"> > </span>
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-btn-container">
                        <button type="button" lay-filter="state" class="layui-btn layui-btn-danger" @click="state"
                            v-show="showStateBtn" :disabled="stateBtnDisabled"
                            :class="stateBtnDisabled?'layui-btn-disabled':''" v-html="stateBtnHtml">
                            >

                        </button>

                        <button type="button" v-show="showRechargeBtn" lay-submit lay-filter="recharge"
                            class="layui-btn layui-bg-green" :disabled="rechargeBtnDisabled"
                            :class="rechargeBtnDisabled?'layui-btn-disabled':''">
                            <i class="fa fa-jpy"></i> 充值
                        </button>

                    </div>
                </div>
            </form>
        </div>
    </div>
    <script src="/lib/layui/layui.js"></script>
    <script src="/lib/vue2/vue.js"></script>
    <script src="/lib/util/amount.js"></script>
    <script src="/lib/util/common.js"></script>
    <script>
        let $, layer;

        let app = new Vue({
            el: '#app',
            data: {
                detail: null
            },
            methods: {
                queryAccount: function () {
                    $.ajax({
                        url: 'api/account/one/current-account-detail.do',
                        success: function (res) {
                            if (!res.success) {
                                if (window.top.progress) {
                                    window.top.progress.error();
                                }
                                layer.msg(res.message, { icon: 2 });
                                return;
                            }
                            //赋值
                            app.detail = res.data;
                        }
                    });
                },
                state: function () {
                    const _this = this;
                    if (!this.detail) {
                        return false;
                    }
                    if (this.detail.account.state === 'canceled' || this.detail.card.state === 'canceled') {
                        return false;
                    }

                    const account = this.detail.account.id;
                    let state = this.detail.card.state;
                    switch (state) {
                        case 'loss': state = 'normal'; break;
                        case 'normal': state = 'loss'; break;
                        default: return false;
                    }

                    layer.open({
                        title: '挂失',
                        content: state === 'normal' ? '确认解挂吗' : '确认挂失吗',
                        btn: ['确定', '取消'],
                        icon: 3,
                        shadeClose: true,
                        btn1: function (index) {
                            $.ajax({
                                url: 'api/card/update/current-state.do',
                                data: { state },
                                type: 'post',
                                success: function (res) {
                                    if (res.success) {
                                        layer.msg(res.message, { icon: 1 });
                                        //重新查询
                                        _this.queryAccount(app.detail.account.id);
                                        return;
                                    }
                                    layer.msg(res.message, { icon: 2 });
                                },
                            });

                        },
                    });
                },
                recharge: function (data) {

                    //目前充值权限只有管理员可以
                    return;

                    const _this = this;
                    if (!this.detail) {
                        return false;
                    }

                    if (this.detail.account.state === 'canceled' || this.detail.card.state === 'canceled') {
                        return false;
                    }

                    layer.prompt({ title: '充值', formType: 0 }, function (amount, index) {
                        //判断是否为金额
                        if (!Amount.isAmount(amount)) {
                            layer.msg('不是金额', { icon: 2 });
                            return false;
                        }

                        //判断小数位数是否为1或2位
                        const dl = Amount.decimalLength(amount);
                        if (!(dl <= 2 && dl >= 0)) {
                            layer.msg(`小数点后最多两位(${dl})`, { icon: 2 });
                            return false;
                        }

                        if (!Amount.inRange(amount, 1, 1000)) {
                            layer.msg(`充值金额在 1~1000 元(${amount})`, { icon: 2 });
                            return false;
                        }

                        // 充值
                        $.ajax({
                            url: 'api/card/update/recharge.do',
                            data: { account: _this.detail.account.id, amount },
                            type: 'post',
                            success: function (res) {
                                if (res.success) {
                                    layer.msg(res.message, { icon: 1 });
                                }
                                if (success) {
                                    success(res);
                                }

                                if (res.success) {
                                    return;
                                }

                                layer.msg(res.message, { icon: 2 });
                            }
                        });
                        layer.close(index);
                    });
                }
            },
            computed: {

                stateBtnDisabled() {
                    return this.detail && this.detail.account.role === 'user' ? this.detail.account.state === 'canceled' : false
                },
                showStateBtn() {
                    if (this.detail) {
                        return this.detail.account.role === 'user';
                    }
                    return true;
                },
                stateBtnHtml() {
                    if (this.detail && this.detail.account.role === 'user' ?
                        (this.detail.card.state === 'canceled' ? true : false) : true) {
                        return '<i class="fa fa-lock"></i> 挂失 / 解挂';
                    }
                    if (this.detail && this.detail.account.role === 'user' ?
                        (this.detail.card.state === 'normal' ? true : false) : false) {
                        return '<i class="fa fa-lock"></i> 挂失';
                    }
                    if (this.detail && this.detail.account.role === 'user' ?
                        (this.detail.card.state === 'loss' ? true : false) : false) {
                        return '<i class="fa fa-unlock"></i> 解挂';
                    }
                },

                rechargeBtnDisabled() {
                    return this.detail ? this.detail.account.state === 'canceled' : false
                },
                showRechargeBtn() {
                    return this.detail ? this.detail.account.role === 'user' : true
                },
                showUserinfo() {
                    return this.detail ? this.detail.account.role === 'user' : true;
                },
                showCardinfo() {
                    return this.detail ? this.detail.account.role === 'user' : true;
                }

            },

        })

        layui.use(function () {
            layer = layui.layer;
            $ = layui.$;
            // ajax全局配置
            common.ajaxSetup($);

            // 搜索
            app.queryAccount();
            return false;
        });
    </script>
</body>

</html>