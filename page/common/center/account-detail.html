<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <title>账户详情</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="/lib/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all" />
    <style>
        #searchBtn {
            position: absolute;
            right: 18px;
        }
    </style>
</head>

<body>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <form class="layui-form layui-form-pane" action="" lay-filter="detail">
                <div class="layui-bg-gray" style="margin-bottom: 15px">
                    <div class="layui-row layui-col-space15">
                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">账户信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="account_tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md6" id="card_block">
                            <div class="layui-card">
                                <div class="layui-card-header">卡信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="card_tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md6" id="user_block">
                            <div class="layui-card">
                                <div class="layui-card-header">用户信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="user_tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-md6">
                            <div class="layui-card">
                                <div class="layui-card-header">部门信息</div>
                                <div class="layui-card-body">
                                    <table class="layui-table" lay-skin="nob">
                                        <tbody id="department_tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script src="/lib/layui/layui.js"></script>
    <script src="/lib/util/common.js"></script>
    <script>
        let form,
            $,
            layer;

        layui.use(['form'], function () {
            layer = layui.layer;
            $ = layui.$;
            form = layui.form;

            // ajax全局配置
            common.ajaxSetup($);

            $.ajax({
                url: common.url('account/one/current-account-detail.do'),
                success: function (res) {
                    if (!res.success) {
                        window.top.progress.error();
                        layer.msg(res.message, { icon: 2 });
                        return;
                    }
                    //赋值
                    setData(res.data);
                }
            });
        });

        /**
         * 设置值
         * @param data 数据, 为null或不传时时清空
         */
        function setData(data) {
            if (data == null || data == undefined) {
                data = {
                    account: {
                        id: '',
                        role: '',
                        state: '',
                    },
                    card: {
                        id: '',
                        account: '',
                        balance: '',
                        state: '',
                    },
                    user: {
                        id: '',
                        name: '',
                        card: '',
                        email: '',
                    },
                    departmentChain: [
                        {
                            id: '',
                            name: '',
                        },
                    ],
                };
            }

            // 几个内容块的id
            const account_tbody = document.querySelector('#account_tbody');
            const card_tbody = document.querySelector('#card_tbody');
            const user_tbody = document.querySelector('#user_tbody');
            const department_tbody = document.querySelector('#department_tbody');

            const user_block = document.querySelector('#user_block');
            const card_block = document.querySelector('#card_block');

            const { account, card, user, departmentChain } = data;

            // 账户
            account_tbody.innerHTML = `<tr>
                        <td>账户ID</td>
                        <td>${account.id}</td>
                    </tr>
                    <tr>
                        <td>账户角色</td>
                        <td>${account.role === 'user'
                    ? '用户'
                    : account.role === 'admin'
                        ? '管理员'
                        : account.role === 'pos'
                            ? '刷卡机'
                            : ''
                }</td>
                    </tr>
                    <tr>
                        <td>账户状态</td>
                        <td>${account.state === 'normal'
                    ? '正常'
                    : account.state === 'canceled'
                        ? '注销'
                        : account.state === 'frozen'
                            ? '冻结'
                            : ''
                }</td>
                    </tr>`;

            // 部门
            let department_str = '';
            departmentChain.forEach((department) => {
                department_str += department.name + ' > ';
            });
            department_tbody.innerHTML = `<tr>
                        <td>ID</td>
                        <td>${departmentChain[departmentChain.length - 1].id}</td>
                    </tr>
                    <tr>
                        <td>部门</td>
                        <td>${department_str.substring(0, department_str.length - 3)}</td>
                    </tr>`;

            // 判断如果不是用户，隐藏用户信息和卡信息
            if (account.role != 'user') {
                user_block.style.display = 'none';
                card_block.style.display = 'none';
                return;
            }
            user_block.style.display = 'block';
            card_block.style.display = 'block';

            // 卡
            card_tbody.innerHTML = `<tr>
                        <td>卡ID</td>
                        <td>${card.id}</td>
                    </tr>
                    <tr>
                        <td>所属账户</td>
                        <td>${card.account}</td>
                    </tr>
                    <tr>
                        <td>卡余额</td>
                        <td>${card.balance === '' ? '' : card.balance / 100}</td>
                    </tr>
                    <tr>
                        <td>卡状态</td>
                        <td>${card.state === 'normal'
                    ? '正常'
                    : card.state === 'canceled'
                        ? '注销'
                        : card.state === 'loss'
                            ? '丢失'
                            : ''
                }</td>
                    </tr>`;

            // 用户
            user_tbody.innerHTML = `<tr>
                        <td>ID</td>
                        <td>${user.id}</td>
                    </tr>
                    <tr>
                        <td>姓名</td>
                        <td>${user.name}</td>
                    </tr>
                    <tr>
                        <td>拥有卡ID</td>
                        <td>${user.card}</td>
                    </tr>
                    <tr>
                        <td>邮件</td>
                        <td>${user.email == null ? '' : user.email}</td>
                    </tr>`;
        }
    </script>
</body>

</html>